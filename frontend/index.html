<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Total Return</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{
      --bg:#0d1321;
      --panel:#141c2f;
      --panel-2:#10182a;
      --text:#e6eefc;
      --muted:#8aa0c2;
      --accent:#3b82f6;
      --green:#20c997;
      --red:#ef4444;
      --yellow:#f59e0b;
      --border:#26324a;
      --chip:#0f1a30;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:linear-gradient(180deg,#0b1222 0%, #0c1426 60%, #0b1222 100%);
      color:var(--text);
      font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    .title{font-size:22px;font-weight:700;margin:0 0 16px}
    .card{
      background:linear-gradient(180deg,var(--panel) 0%, var(--panel-2) 100%);
      border:1px solid var(--border);
      border-radius:12px;
      padding:16px;
      box-shadow:0 6px 24px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.02);
    }
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .row + .row{margin-top:10px}
    input[type=file]{
      display:inline-block;
      padding:8px;
      background:#0e1730;
      border:1px solid var(--border);
      color:var(--muted);
      border-radius:10px;
      max-width:420px;
    }
    button{
      border:1px solid var(--border);
      background:linear-gradient(180deg,#1a2a52,#152444);
      color:#dbe7ff;
      padding:10px 14px;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
    }
    button.primary{
      border-color:#2450a8;
      background:linear-gradient(180deg,#2351aa,#1a3e83);
    }
    button:disabled{opacity:.6;cursor:not-allowed}
    .muted{color:var(--muted);font-size:12px}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .chip{
      background:linear-gradient(180deg,#0e1730,#0c1428);
      border:1px solid var(--border);
      padding:6px 10px;
      border-radius:999px;
      font-weight:700;
      font-size:12px;
      color:#bcd0f3;
    }
    .chip strong{color:#fff;margin-left:6px}
    table{width:100%;border-collapse:collapse;margin-top:14px}
    thead th{
      text-align:left;
      font-size:12px;
      color:#b7c7e6;
      border-bottom:1px solid var(--border);
      padding:10px 10px;
      white-space:nowrap;
      position:sticky; top:0; z-index:2;
      background:linear-gradient(180deg,var(--panel) 0%, var(--panel-2) 100%);
    }
    tbody td{
      border-bottom:1px dashed #1d2a44;
      padding:10px 10px;
      vertical-align:top;
      white-space:nowrap;
    }
    tbody tr:hover{background:#0e1528}
    .right{text-align:right}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .pos{color:var(--green);font-weight:700}
    .neg{color:var(--red);font-weight:700}
    .warn{color:var(--yellow)}
    .sortable{cursor:pointer; user-select:none}
    .th-ind{margin-left:6px; opacity:.8}
    .toolbar{display:flex;gap:10px;align-items:center;margin-top:8px}
    .small{font-size:12px}
    .pill{padding:6px 10px;border-radius:999px;background:#0e1730;border:1px solid var(--border)}
    .spacer{flex:1}
    .note{margin-top:8px}
    .hidden{display:none}
    .support{margin-top:16px;text-align:center;font-size:12px}
    .support a{color:var(--accent);text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">Total Return... because dividends matter</div>

    <div class="card">
      <div class="row">
        <form id="uploadActivity" class="row">
          <input type="file" id="activityFile" accept=".csv" multiple>
          <button type="submit">Upload activity CSVs</button>
          <span id="statusA" class="muted"></span>
        </form>
      </div>
      <div class="row">
        <form id="uploadPositions" class="row">
          <input type="file" id="positionsFile" accept=".csv" multiple>
          <button type="submit">Upload positions CSVs</button>
          <span id="statusP" class="muted"></span>
        </form>
      </div>
      <div class="toolbar">
        <button id="recalc" class="primary">Recalculate</button>
        <button id="clear">Clear</button>
        <div class="spacer"></div>
        <span class="small pill muted" id="missing"></span>
      </div>
      <div class="chips" id="chips">
        <span class="chip">Invested <strong id="chipInvested">0.00</strong></span>
        <span class="chip">Dividends <strong id="chipDivs">0.00</strong></span>
        <span class="chip">Market <strong id="chipMarket">0.00</strong></span>
        <span class="chip">Total $ <strong id="chipTotal">0.00</strong></span>
        <span class="chip">Total % <strong id="chipTotalPct">n/a</strong></span>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <table id="tbl">
        <thead>
          <tr>
            <th class="sortable" data-key="symbol">Symbol <span class="th-ind" id="ind-symbol"></span></th>
            <th class="right sortable" data-key="shares">Shares <span class="th-ind" id="ind-shares"></span></th>
            <th class="right sortable" data-key="net_invested_cash">Invested <span class="th-ind" id="ind-net_invested_cash"></span></th>
            <th class="right sortable" data-key="dividends_received">Dividends <span class="th-ind" id="ind-dividends_received"></span></th>
            <th class="right sortable" data-key="current_price">Price <span class="th-ind" id="ind-current_price"></span></th>
            <th class="right sortable" data-key="market_value">Market Value <span class="th-ind" id="ind-market_value"></span></th>
            <th class="right sortable" data-key="market_gain_dollars">Market Gain $ <span class="th-ind" id="ind-market_gain_dollars"></span></th>
            <th class="right sortable" data-key="market_gain_percent">Market Gain % <span class="th-ind" id="ind-market_gain_percent"></span></th>
            <th class="right sortable" data-key="total_return_dollars">Total Return $ <span class="th-ind" id="ind-total_return_dollars"></span></th>
            <th class="right sortable" data-key="total_return_percent">Total Return % <span class="th-ind" id="ind-total_return_percent"></span></th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
      <div id="empty" class="note muted">Upload your CSVs, then click Recalculate.</div>
    </div>

    <div class="support muted">
      Enjoy the tool? <a href="https://ko-fi.com/gille" target="_blank">Support it on Ko-fi</a>.
    </div>
  </div>

  <script>
    const $ = sel => document.querySelector(sel);
    const rowsEl = $("#rows");
    const emptyEl = $("#empty");
    const missingEl = $("#missing");
    let sortKey = 'symbol';
    let sortDir = 'asc'; // 'asc' | 'desc'
    let lastRows = [];
    const numericKeys = new Set(['shares','net_invested_cash','dividends_received','current_price','market_value','market_gain_dollars','market_gain_percent','total_return_dollars','total_return_percent']);

    function updateSortIndicators(){
      document.querySelectorAll('thead th .th-ind').forEach(el => el.textContent = '');
      const ind = $("#ind-"+sortKey);
      if (ind) ind.textContent = sortDir === 'asc' ? '▲' : '▼';
    }

    function cmp(a,b){
      let av = a?.[sortKey];
      let bv = b?.[sortKey];
      const numeric = numericKeys.has(sortKey);
      const missingA = (av===null || av===undefined || (numeric && isNaN(Number(av))));
      const missingB = (bv===null || bv===undefined || (numeric && isNaN(Number(bv))));
      if (missingA && missingB) return 0;
      if (missingA) return 1; // push missing to bottom
      if (missingB) return -1;
      if (numeric){
        av = Number(av); bv = Number(bv);
      } else {
        av = String(av).toUpperCase(); bv = String(bv).toUpperCase();
      }
      if (av < bv) return sortDir === 'asc' ? -1 : 1;
      if (av > bv) return sortDir === 'asc' ? 1 : -1;
      return 0;
    }

    function fmtCurrency(v){
      if (v === null || v === undefined) return "n/a";
      const sign = v < 0 ? "-" : "";
      const n = Math.abs(v);
      return sign + "$" + n.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
    }
    function fmtNumber(v, d=6){
      if (v === null || v === undefined) return "n/a";
      return Number(v).toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:d});
    }
    function fmtPrice(v){
      if (v === null || v === undefined) return "n/a";
      return "$" + Number(v).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:4});
    }
    function fmtPct(v){
      if (v === null || v === undefined || isNaN(v)) return "n/a";
      return Number(v).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}) + "%";
    }

    async function postFile(url, file) {
      const fd = new FormData();
      fd.append("file", file);
      const r = await fetch(url, { method:"POST", body: fd });
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }

    $("#uploadActivity").addEventListener("submit", async (e) => {
      e.preventDefault();
      const files = $("#activityFile").files;
      const status = $("#statusA");
      if (!files || files.length === 0) return;
      status.textContent = "Uploading...";
      try{
        for (const f of files) await postFile("/upload", f);
        status.textContent = "Uploaded";
        await refresh();
      }catch(err){
        status.textContent = "Error: " + err.message;
      }
    });

    $("#uploadPositions").addEventListener("submit", async (e) => {
      e.preventDefault();
      const files = $("#positionsFile").files;
      const status = $("#statusP");
      if (!files || files.length === 0) return;
      status.textContent = "Uploading...";
      try{
        for (const f of files) await postFile("/upload_positions", f);
        status.textContent = "Uploaded";
        await refresh();
      }catch(err){
        status.textContent = "Error: " + err.message;
      }
    });

    $("#recalc").addEventListener("click", async () => {
      await refresh();
    });

    $("#clear").addEventListener("click", async () => {
      const btn = $("#clear");
      btn.disabled = true;
      try {
        const r = await fetch("/clear", { method: "POST" });
        if (!r.ok) throw new Error(await r.text());
        $("#statusA").textContent = "";
        $("#statusP").textContent = "";
        $("#activityFile").value = "";
        $("#positionsFile").value = "";
        paintSummary({invested:0,dividends:0,market_value:0,total_return_dollars:0,total_return_percent:null});
        rowsEl.innerHTML = "";
        emptyEl.classList.remove("hidden");
        missingEl.textContent = "";
        lastRows = [];
      } catch(err) {
        missingEl.textContent = "Error: " + err.message;
      } finally {
        btn.disabled = false;
      }
    });

    function paintSummary(overall){
      $("#chipInvested").textContent = fmtCurrency(overall.invested);
      $("#chipDivs").textContent = fmtCurrency(overall.dividends);
      $("#chipMarket").textContent = fmtCurrency(overall.market_value);
      $("#chipTotal").textContent = fmtCurrency(overall.total_return_dollars);
      $("#chipTotalPct").textContent = overall.total_return_percent==null ? "n/a" : fmtPct(overall.total_return_percent);
    }

    function paintTable(rows){
      rowsEl.innerHTML = "";
      if (!rows || rows.length === 0){
        emptyEl.classList.remove("hidden");
        return;
      }
      emptyEl.classList.add("hidden");
      const sorted = rows.slice().sort(cmp);
      updateSortIndicators();
      for (const r of sorted){
        const tr = document.createElement("tr");

        const tdSym = document.createElement("td");
        tdSym.textContent = r.symbol;
        tr.appendChild(tdSym);

        const tdShares = document.createElement("td");
        tdShares.className = "right mono";
        tdShares.textContent = fmtNumber(r.shares, 6);
        tr.appendChild(tdShares);

        const tdInv = document.createElement("td");
        tdInv.className = "right mono";
        tdInv.textContent = fmtCurrency(r.net_invested_cash);
        tr.appendChild(tdInv);

        const tdDiv = document.createElement("td");
        tdDiv.className = "right mono";
        tdDiv.textContent = fmtCurrency(r.dividends_received);
        tr.appendChild(tdDiv);

        const tdPrice = document.createElement("td");
        tdPrice.className = "right mono";
        tdPrice.innerHTML = r.current_price==null ? '<span class="warn">n/a</span>' : fmtPrice(r.current_price);
        tr.appendChild(tdPrice);

        const tdMV = document.createElement("td");
        tdMV.className = "right mono";
        tdMV.textContent = r.market_value==null ? "n/a" : fmtCurrency(r.market_value);
        tr.appendChild(tdMV);

        const tdMG$ = document.createElement("td");
        tdMG$.className = "right mono";
        if (r.market_gain_dollars==null){
          tdMG$.innerHTML = '<span class="warn">n/a</span>';
        }else{
          const cls = r.market_gain_dollars >= 0 ? "pos" : "neg";
          tdMG$.innerHTML = '<span class="'+cls+'">'+fmtCurrency(r.market_gain_dollars)+'</span>';
        }
        tr.appendChild(tdMG$);

        const tdMGp = document.createElement("td");
        tdMGp.className = "right mono";
        if (r.market_gain_percent==null){
          tdMGp.innerHTML = '<span class="warn">n/a</span>';
        }else{
          const cls = r.market_gain_percent >= 0 ? "pos" : "neg";
          tdMGp.innerHTML = '<span class="'+cls+'">'+fmtPct(r.market_gain_percent)+'</span>';
        }
        tr.appendChild(tdMGp);

        const tdTR$ = document.createElement("td");
        tdTR$.className = "right mono";
        if (r.total_return_dollars==null){
          tdTR$.innerHTML = '<span class="warn">n/a</span>';
        }else{
          const cls = r.total_return_dollars >= 0 ? "pos" : "neg";
          tdTR$.innerHTML = '<span class="'+cls+'">'+fmtCurrency(r.total_return_dollars)+'</span>';
        }
        tr.appendChild(tdTR$);

        const tdTRp = document.createElement("td");
        tdTRp.className = "right mono";
        if (r.total_return_percent==null){
          tdTRp.innerHTML = '<span class="warn">n/a</span>';
        }else{
          const cls = r.total_return_percent >= 0 ? "pos" : "neg";
          tdTRp.innerHTML = '<span class="'+cls+'">'+fmtPct(r.total_return_percent)+'</span>';
        }
        tr.appendChild(tdTRp);

        rowsEl.appendChild(tr);
      }
    }

    async function refresh(){
      const btn = $("#recalc");
      btn.disabled = true;
      try{
        const r = await fetch("/portfolio");
        if (!r.ok){
          const txt = await r.text();
          throw new Error(txt || "Server error");
        }
        const data = await r.json();
        const rows = data.rows || [];
        lastRows = rows;
        paintSummary(data.overall || {invested:0,dividends:0,market_value:0,total_return_dollars:0,total_return_percent:null});
        paintTable(lastRows);
        const missing = (data.missing_prices || []).filter(Boolean);
        if (missing.length){
          missingEl.textContent = "Missing prices: " + missing.join(", ");
        }else{
          missingEl.textContent = "";
        }
      }catch(err){
        paintSummary({invested:0,dividends:0,market_value:0,total_return_dollars:0,total_return_percent:null});
        rowsEl.innerHTML = "";
        emptyEl.classList.remove("hidden");
        missingEl.textContent = "Error: " + (err.message || err);
        lastRows = [];
      }finally{
        btn.disabled = false;
      }
    }

    // Hook up sorting
    document.querySelectorAll('thead th.sortable').forEach(th => {
      th.addEventListener('click', () => {
        const key = th.getAttribute('data-key');
        if (!key) return;
        if (sortKey === key){
          sortDir = sortDir === 'asc' ? 'desc' : 'asc';
        } else {
          sortKey = key;
          sortDir = 'asc';
        }
        // Re-render using cached rows; avoid re-calling server since uploads are cleared after compute
        paintTable(lastRows);
      });
    });

    // Initial try; harmless if no files yet
    refresh();
  </script>
  <div class="wrap" style="margin-top:8px">
    <div class="card">
      <div class="title" style="font-size:16px;margin-bottom:8px">Legend: How calculations work</div>
      <div class="small muted">
        <div><strong>Shares</strong>: From positions file (authoritative).</div>
        <div><strong>Invested</strong>: Cost basis from positions; if missing/0, falls back to net invested from activity (cash out on buys minus proceeds from sells).</div>
        <div><strong>Dividends</strong>: Sum of positive amounts for “DIVIDEND RECEIVED …” in activity.</div>
        <div><strong>Price</strong>: Latest close from Yahoo Finance.</div>
        <div><strong>Market Value</strong>: current price × shares.</div>
        <div><strong>Market Gain $</strong>: market value − invested (excludes dividends).</div>
        <div><strong>Market Gain %</strong>: market gain $ ÷ invested × 100 (if invested &gt; 0).</div>
        <div><strong>Total Return $</strong>: market value + dividends − invested.</div>
        <div><strong>Total Return %</strong>: total return $ ÷ invested × 100 (if invested &gt; 0).</div>
      </div>
    </div>
  </div>
</body>
</html>
